<!-- Ver 3.9: 로그아웃(방문자) 데이터 로딩 허용 & 방명록 작성 차단 해제 -->
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>우승수 블로그</title>
    
    <!-- 폰트 및 아이콘 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Myeongjo:wght@400;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- 테마 및 기본 스타일 --- */
        :root {
            --bg-app: #fdfbf7; --bg-panel: #ffffff; --bg-sidebar: #f4f4f2;
            --text-main: #2c2c2c; --text-sub: #5f5f5f; --accent: #d94844;
            --border: #e0e0e0; --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --nav-height: 60px;
        }
        body.dark-mode {
            --bg-app: #121212; --bg-panel: #1e1e1e; --bg-sidebar: #181818;
            --text-main: #e0e0e0; --text-sub: #a0a0a0; --accent: #ff8a80;
            --border: #333333; --shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Nanum Myeongjo', serif; background-color: var(--bg-app);
            color: var(--text-main); margin: 0; height: 100vh; overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* --- 네비게이션 --- */
        nav {
            height: var(--nav-height); background-color: var(--bg-panel);
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between;
            align-items: center; 
            padding: 0 24px; 
            position: fixed; top: 0; width: 100%; z-index: 100;
            transition: height 0.3s ease;
        }
        .nav-logo { font-weight: 800; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .nav-controls { display: flex; gap: 8px; background: var(--bg-sidebar); padding: 4px; border-radius: 8px; }
        .nav-tab { background: none; border: none; padding: 6px 16px; border-radius: 6px; cursor: pointer; color: var(--text-sub); transition: all 0.2s; font-size: 0.9rem; }
        .nav-tab.active { background-color: var(--bg-panel); color: var(--text-main); font-weight: 700; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        
        #tab-editor { display: none; }
        #tab-editor.visible { display: block; }
        #tab-login-trigger { display: block; }

        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; margin-left: 10px; }
        .status-dot.connected { background: #4caf50; box-shadow: 0 0 5px #4caf50; }

        /* --- 레이아웃 --- */
        #app-container { margin-top: var(--nav-height); height: calc(100vh - var(--nav-height)); }
        .view-section { display: none; height: 100%; width: 100%; }
        .view-section.active { display: block; }
        .view-section.active.flex-view { display: flex; }

        .scroll-container { width: 100%; height: 100%; overflow-y: auto; padding-top: 40px; -webkit-overflow-scrolling: touch; }
        .inner-content { max-width: 800px; margin: 0 auto; padding: 0 24px 40px 24px; }
        
        /* --- 블로그 홈 --- */
        #tag-cloud { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 1px solid var(--border); }
        .tag-badge { padding: 6px 14px; border-radius: 50px; background: var(--bg-sidebar); font-size: 0.85rem; cursor: pointer; transition: all 0.2s; color: var(--text-sub); }
        .tag-badge:hover { background: var(--border); color: var(--text-main); }
        .tag-badge.active { background: var(--text-main); color: var(--bg-panel); font-weight: 700; }

        .post-card { background-color: var(--bg-panel); border: 1px solid var(--border); padding: 30px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: transform 0.2s; }
        .post-card:hover { transform: translateY(-2px); border-color: var(--accent); }
        .card-meta { font-size: 0.8rem; color: var(--text-sub); display: flex; justify-content: space-between; align-items: center; }
        .card-tags { display: flex; gap: 6px; }
        .card-tag-item { font-size: 0.75rem; color: var(--accent); }
        .card-title { font-size: 1.5rem; margin: 10px 0; font-weight: 700; line-height: 1.3; }
        
        .card-excerpt { 
            color: var(--text-sub); 
            line-clamp: 3;
            -webkit-line-clamp: 3;
            display: -webkit-box; 
            -webkit-box-orient: vertical; 
            overflow: hidden; 
            line-height: 1.6; 
        }

        /* --- 방명록 --- */
        .guestbook-form { background: var(--bg-panel); border: 1px solid var(--border); padding: 24px; border-radius: 12px; margin-bottom: 40px; }
        .gb-input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .gb-input-row input { flex: 1; border: 1px solid var(--border); background: var(--bg-app); padding: 10px 14px; border-radius: 8px; font-family: inherit; color: var(--text-main); outline: none; font-size: 0.9rem; }
        .gb-textarea { width: 100%; min-height: 100px; border: 1px solid var(--border); background: var(--bg-app); padding: 14px; border-radius: 8px; font-family: inherit; color: var(--text-main); outline: none; resize: none; margin-bottom: 12px; font-size: 1rem; }
        .gb-submit { width: 100%; padding: 12px; background: var(--text-main); color: var(--bg-panel); border: none; border-radius: 8px; font-weight: 700; transition: opacity 0.2s; font-size: 1rem; }
        #guestbook-list { border-top: 1px solid var(--border); border-left: 1px solid var(--border); border-right: 1px solid var(--border); border-radius: 12px; overflow: hidden; background: var(--bg-panel); }
        .guest-item { padding: 20px; border-bottom: 1px solid var(--border); position: relative; }
        .guest-header { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.85rem; color: var(--text-sub); align-items: center; }
        .guest-info { display: flex; align-items: center; gap: 8px; }
        .guest-name { font-weight: 800; color: var(--text-main); }
        .guest-actions { display: flex; gap: 8px; align-items: center; }
        .gb-action-btn { background: none; border: none; padding: 4px; color: var(--text-sub); cursor: pointer; font-size: 1.1rem; border-radius: 4px; display: flex; align-items: center; justify-content: center; }
        .gb-action-btn:hover { background: var(--bg-sidebar); color: var(--text-main); }
        .admin-del-btn { color: var(--accent); }
        .guest-content { line-height: 1.6; white-space: pre-wrap; font-size: 1.05rem; }

        /* --- 에디터 --- */
        .editor-sidebar { width: 300px; min-width: 300px; flex-shrink: 0; background-color: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding-top: 0; overflow: hidden; }
        .editor-sidebar.collapsed { width: 0; min-width: 0; border-right: none; }
        .sidebar-header { padding: 15px 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background-color: var(--bg-sidebar); flex-shrink: 0; height: 60px; }
        .sidebar-title { font-weight: 800; font-size: 1.1rem; }
        .sidebar-close-btn { background: none; border: none; font-size: 1.3rem; cursor: pointer; padding: 5px; display: none; color: var(--text-main); }
        .sidebar-list { list-style: none; padding: 10px 8px; margin: 0; flex: 1; overflow-y: auto; }
        .list-item { padding: 12px 16px; border-radius: 8px; margin-bottom: 5px; cursor: pointer; position: relative; }
        .list-item:hover { background-color: rgba(0,0,0,0.05); }
        .list-item.active { background-color: var(--bg-panel); border: 1px solid var(--border); font-weight: 700; color: var(--accent); }
        .item-delete-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: none; color: #aaa; cursor: pointer; padding: 8px; display: none; }
        .list-item:hover .item-delete-btn { display: block; }
        .new-post-trigger { width: 100%; padding: 18px; background-color: var(--bg-panel); border: none; border-top: 1px solid var(--border); color: var(--text-main); cursor: pointer; font-size: 1rem; font-weight: 700; display: flex; justify-content: center; align-items: center; gap: 8px; }

        .editor-main { flex: 1; background-color: var(--bg-panel); display: flex; flex-direction: column; min-width: 0; }
        .editor-toolbar { padding: 10px 20px; border-bottom: none; display: flex; gap: 12px; align-items: center; }
        .tool-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-sub); cursor: pointer; padding: 8px; border-radius: 8px; }
        .tool-btn:hover { color: var(--text-main); background-color: var(--border); }
        
        .editor-canvas { flex: 1; padding: 40px 32px; overflow-y: auto; max-width: 900px; margin: 0 auto; width: 100%; display: flex; flex-direction: column; }
        #input-title { width: 100%; border: none; background: transparent; font-size: 2.2rem; font-weight: 800; font-family: inherit; color: var(--text-main); outline: none; margin-bottom: 10px; line-height: 1.3; padding: 0; resize: none; overflow: hidden; height: auto; min-height: 44px; display: block; }
        .tag-input-container { display: flex; gap: 10px; margin-bottom: 30px; max-width: 450px; }
        .tag-input-field { flex: 1; border: none; border-bottom: 1px solid var(--border); background: transparent; padding: 6px 0; font-size: 0.9rem; font-family: inherit; outline: none; color: var(--accent); min-width: 0; }
        .tag-input-field::placeholder { color: var(--border); opacity: 0.7; }
        #input-content { width: 100%; flex: 1; min-height: 400px; outline: none; font-size: 1.15rem; line-height: 1.8; color: var(--text-main); padding: 0; }
        #input-content:empty:before { content: '내용을 입력하세요.'; color: var(--text-sub); opacity: 0.5; }

        /* 모달 및 로그인 */
        .modal { position: fixed; inset: 0; background: var(--bg-app); z-index: 200; overflow-y: auto; padding: 60px 24px; display: none; }
        .modal.open { display: block; animation: slideUp 0.3s; }
        .close-btn { position: fixed; top: 24px; right: 24px; width: 48px; height: 48px; background: none; border: none; cursor: pointer; z-index: 201; font-size: 2rem; color: var(--text-main); }
        #login-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 300; display: none; justify-content: center; align-items: center; padding: 20px; }
        #login-modal.open { display: flex; }
        .login-box { background: var(--bg-panel); padding: 30px; border-radius: 16px; width: 100%; max-width: 340px; text-align: center; }
        .login-input { width: 100%; padding: 14px; margin-bottom: 12px; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-app); color: var(--text-main); font-size: 1rem; }
        .login-btn { width: 100%; padding: 14px; background: var(--text-main); color: var(--bg-panel); border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 999; display: none; opacity: 0; transition: opacity 0.3s; }
        #sidebar-overlay.open { display: block; opacity: 1; }

        @media (max-width: 768px) {
            :root { --nav-height: 56px; }
            nav { padding: 0 16px; }
            .editor-sidebar { position: fixed; top: 0; bottom: 0; left: -85%; width: 85%; max-width: 320px; z-index: 1000; min-width: auto; }
            .editor-sidebar.open { left: 0; }
            .sidebar-close-btn { display: flex; }
            .editor-canvas { padding: 20px 32px; }
            .tag-input-container { flex-direction: column; gap: 5px; max-width: 100%; }
        }
    </style>
</head>
<body>

    <div id="login-modal">
        <div class="login-box">
            <h2 style="margin-bottom:15px;">관리자 로그인</h2>
            <p style="font-size:0.9rem; color:var(--text-sub); margin-bottom:25px;">우승수 블로그의 주인장 전용입니다.</p>
            <input type="email" id="login-email" class="login-input" placeholder="이메일">
            <input type="password" id="login-pw" class="login-input" placeholder="비밀번호" onkeyup="if(window.event.keyCode==13){adminLogin()}">
            <button class="login-btn" onclick="adminLogin()">로그인</button>
            <button onclick="closeLogin()" style="background:none; border:none; color:var(--text-sub); margin-top:15px; cursor:pointer; text-decoration:underline;">돌아가기</button>
        </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()"></div>

    <nav>
        <div class="nav-logo" onclick="switchView('blog')">
            <span>우승수 블로그</span>
            <div id="conn-status" class="status-dot"></div>
        </div>
        <div class="nav-controls">
            <button class="nav-tab active" onclick="switchView('blog')">블로그</button>
            <button class="nav-tab" onclick="switchView('guestbook')">방명록</button>
            <button class="nav-tab" id="tab-editor" onclick="switchView('editor')">에디터</button>
            <button class="nav-tab" id="tab-login-trigger" onclick="openLogin()">로그인</button>
        </div>
        <button class="nav-tab" onclick="toggleTheme()"><i class="ph ph-moon" id="theme-icon"></i></button>
    </nav>

    <main id="app-container">
        <!-- 1. 블로그 뷰 -->
        <section id="view-blog" class="view-section active">
            <div class="scroll-container">
                <div class="inner-content">
                    <div id="tag-cloud"></div>
                    <div id="blog-list">데이터를 불러오는 중...</div>
                </div>
            </div>
        </section>

        <!-- 2. 방명록 뷰 -->
        <section id="view-guestbook" class="view-section">
            <div class="scroll-container">
                <div class="inner-content">
                    <h2 style="text-align:center; margin-bottom:30px;">방명록</h2>
                    <div class="guestbook-form">
                        <div class="gb-input-row">
                            <input type="text" id="gb-name" placeholder="이름 (익명 가능)">
                            <input type="password" id="gb-password" placeholder="비밀번호 (수정/삭제용)">
                        </div>
                        <textarea id="gb-content" class="gb-textarea" placeholder="할 말 있니?"></textarea>
                        <button class="gb-submit" onclick="submitGuestbook()">글 남기기</button>
                    </div>
                    <div id="guestbook-list"></div>
                </div>
            </div>
        </section>

        <!-- 3. 에디터 뷰 -->
        <section id="view-editor" class="view-section flex-view">
            <aside class="editor-sidebar" id="sidebar-panel">
                <div class="sidebar-header">
                    <span class="sidebar-title">글 목록</span>
                    <button class="sidebar-close-btn" onclick="toggleSidebar()"><i class="ph ph-x"></i></button>
                </div>
                <ul id="editor-list" class="sidebar-list"></ul>
                <button class="new-post-trigger" onclick="createNewPost()">
                    <i class="ph-bold ph-plus"></i> 새 글 작성
                </button>
            </aside>
            <div class="editor-main">
                <div class="editor-toolbar">
                    <button class="tool-btn" onclick="toggleSidebar()" title="목록 접기/펴기"><i class="ph ph-list"></i></button>
                    <button class="tool-btn" onclick="manualSaveWithAlert()" title="저장하기"><i class="ph ph-floppy-disk"></i></button>
                    <button class="tool-btn" onclick="deleteCurrentPost()" title="현재 글 삭제"><i class="ph ph-trash"></i></button>
                    <button class="tool-btn" onclick="adminLogout()" title="로그아웃" style="margin-left:auto;"><i class="ph ph-sign-out"></i></button>
                </div>
                <div class="editor-canvas">
                    <textarea id="input-title" placeholder="제목 입력" rows="1" oninput="autoResize(this); triggerAutoSave()"></textarea>
                    <div class="tag-input-container">
                        <input type="text" id="tag-1" class="tag-input-field" placeholder="#태그1" oninput="triggerAutoSave()">
                        <input type="text" id="tag-2" class="tag-input-field" placeholder="#태그2" oninput="triggerAutoSave()">
                        <input type="text" id="tag-3" class="tag-input-field" placeholder="#태그3" oninput="triggerAutoSave()">
                    </div>
                    <div id="input-content" contenteditable="true" oninput="triggerAutoSave()"></div>
                </div>
            </div>
        </section>
    </main>

    <div id="reader-modal" class="modal">
        <button class="close-btn" onclick="closeReader()"><i class="ph ph-x"></i></button>
        <div style="max-width:720px; margin:0 auto;">
            <h1 id="r-title" style="font-size:2.5rem; margin-bottom:12px; line-height:1.3;"></h1>
            <div id="r-meta" style="color:var(--text-sub); border-bottom:1px solid var(--border); padding-bottom:20px; margin-bottom:30px; font-size:0.9rem; display:flex; gap:15px;">
                <span id="r-date"></span>
                <span id="r-tags" style="color:var(--accent);"></span>
            </div>
            <div id="r-content" style="font-size:1.15rem; line-height:1.8;"></div>
        </div>
    </div>

    <script type="module">
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDa6TJOoCplZR6fz7bGXzWRF3hLk8zYJ_A",
            authDomain: "seungsu-woo.firebaseapp.com",
            projectId: "seungsu-woo",
            storageBucket: "seungsu-woo.firebasestorage.app",
            messagingSenderId: "11949728709",
            appId: "1:11949728709:web:50d7ac696f3f98698561ac",
            measurementId: "G-GLZ4G2FRH3"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'seungsu-woo';

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInAnonymously, signInWithCustomToken, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let user = null, posts = [], guestbook = [], currentId = null, selectedTag = null;
        
        // [수정] 데이터 로드는 앱 시작 시 한 번 무조건 실행 (인증 여부 무관)
        function startDataLoad() {
            // 블로그 게시글 리스너
            const postsCol = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            onSnapshot(query(postsCol), (sn) => {
                posts = sn.docs.map(d => ({ 
                    id: d.id, ...d.data(), 
                    date: d.data().createdAt ? d.data().createdAt.toDate().toLocaleDateString('ko-KR') : '날짜 없음' 
                }));
                posts.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderTagCloud(); 
                renderBlog();
                // 관리자일 때만 에디터 리스트 갱신
                if (user && !user.isAnonymous) renderEditorList(); 
            });

            // 방명록 리스너
            const gbCol = collection(db, 'artifacts', appId, 'public', 'data', 'guestbook');
            onSnapshot(query(gbCol), (sn) => {
                guestbook = sn.docs.map(d => ({ 
                    id: d.id, ...d.data(), 
                    date: d.data().createdAt ? d.data().createdAt.toDate().toLocaleString('ko-KR', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'}) : '방금 전' 
                }));
                guestbook.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
                renderGuestbook();
            });
        }
        
        // 앱 시작 즉시 데이터 로드 시작
        startDataLoad();

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth).catch(() => {});
                }
            } catch (e) { console.error("Auth:", e); }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            const dot = document.getElementById('conn-status');
            const editorTab = document.getElementById('tab-editor');
            const loginBtn = document.getElementById('tab-login-trigger');

            if (user) {
                dot.classList.add('connected');
                // 관리자만 에디터 탭 보임
                if (user.isAnonymous) {
                    editorTab.classList.remove('visible');
                    loginBtn.style.display = 'block';
                    dot.title = "방문자 모드";
                } else {
                    editorTab.classList.add('visible');
                    loginBtn.style.display = 'none';
                    dot.title = "관리자 모드";
                    renderEditorList(); // 로그인 직후 리스트 갱신
                }
            } else {
                dot.classList.remove('connected');
                // 로그아웃 시 자동 익명 로그인 시도
                initAuth();
            }
        });

        // --- 기능 로직 ---
        window.submitGuestbook = async () => {
            const nameEl = document.getElementById('gb-name');
            const pwEl = document.getElementById('gb-password');
            const contentEl = document.getElementById('gb-content');
            
            const name = nameEl.value.trim() || "익명";
            const password = pwEl.value.trim();
            const content = contentEl.value.trim();

            if (!content) return alert("할 말을 입력해주세요.");
            if (!password) return alert("비밀번호를 입력해주세요.");

            try {
                // [수정] user 여부 체크 제거 (방문자도 작성 가능)
                const gbCol = collection(db, 'artifacts', appId, 'public', 'data', 'guestbook');
                await addDoc(gbCol, { name, password, content, createdAt: serverTimestamp() });
                contentEl.value = ""; // 내용만 지움 (이름/비번은 편의상 유지 가능하나 여기선 초기화 안함 권장.. 일단 초기화)
                nameEl.value = ""; pwEl.value = ""; 
            } catch (e) { alert("저장 실패 (권한 문제일 수 있습니다. 파이어베이스 규칙을 확인하세요)"); }
        };

        function renderGuestbook() {
            const el = document.getElementById('guestbook-list');
            const isAdmin = user && !user.isAnonymous;
            if (guestbook.length === 0) { el.innerHTML = ''; return; }
            el.innerHTML = guestbook.map(g => `
                <div class="guest-item">
                    <div class="guest-header">
                        <div class="guest-info"><span class="guest-name">${g.name}</span><span>${g.date}</span></div>
                        <div class="guest-actions">
                            ${isAdmin ? `<button class="gb-action-btn admin-del-btn" onclick="deleteGuestbookEntry('${g.id}', true)"><i class="ph-bold ph-x"></i></button>` : ''}
                            <button class="gb-action-btn" onclick="manageGuestbookEntry('${g.id}')"><i class="ph ph-gear"></i></button>
                        </div>
                    </div>
                    <div class="guest-content">${g.content}</div>
                </div>
            `).join('');
        }

        window.manageGuestbookEntry = async (id) => {
            const entry = guestbook.find(g => g.id === id);
            const pw = prompt("비밀번호를 입력하세요.");
            if (!pw || entry.password !== pw) return alert("비밀번호가 틀렸습니다.");

            const action = confirm("확인: 삭제 / 취소: 내용 수정");
            if (action) { if (confirm("삭제할까요?")) await deleteGuestbookEntry(id); }
            else {
                const newC = prompt("수정할 내용", entry.content);
                if (newC && newC !== entry.content) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guestbook', id), { content: newC });
                }
            }
        };

        window.deleteGuestbookEntry = async (id, isForce = false) => {
            if (!isForce && !confirm("삭제하시겠습니까?")) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'guestbook', id)); } catch (e) { alert("삭제 실패"); }
        };

        window.autoResize = (el) => { if (!el) return; el.style.height = 'auto'; el.style.height = (el.scrollHeight > 44 ? el.scrollHeight : 44) + 'px'; };
        
        window.switchView = (v) => {
            if (v === 'editor' && (!user || user.isAnonymous)) return openLogin();
            document.querySelectorAll('.view-section').forEach(e => e.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(t => t.classList.remove('active'));
            if(v === 'blog') document.querySelectorAll('.nav-tab')[0].classList.add('active');
            else if(v === 'guestbook') document.querySelectorAll('.nav-tab')[1].classList.add('active');
            else if(v === 'editor') document.querySelectorAll('.nav-tab')[2].classList.add('active');
        };

        window.openLogin = () => document.getElementById('login-modal').classList.add('open');
        window.closeLogin = () => document.getElementById('login-modal').classList.remove('open');
        
        window.adminLogin = async () => {
            const email = document.getElementById('login-email').value, pw = document.getElementById('login-pw').value;
            try { 
                await signInWithEmailAndPassword(auth, email, pw); 
                document.getElementById('login-modal').classList.remove('open'); 
                switchView('editor'); 
            } catch (e) { alert("로그인 실패"); }
        };
        
        window.adminLogout = async () => { if(confirm("로그아웃 하시겠습니까?")) { await signOut(auth); location.reload(); } };

        window.createNewPost = () => {
            currentId = null; const titleEl = document.getElementById('input-title');
            titleEl.value = ""; autoResize(titleEl);
            ['tag-1', 'tag-2', 'tag-3'].forEach(id => document.getElementById(id).value = "");
            document.getElementById('input-content').innerHTML = ""; renderEditorList();
            if(window.innerWidth <= 768) toggleSidebar();
        };

        let autoSaveTimer;
        window.triggerAutoSave = () => { clearTimeout(autoSaveTimer); autoSaveTimer = setTimeout(manualSave, 2000); };
        
        window.manualSave = async () => {
            if (!db || !user || user.isAnonymous) return;
            const title = document.getElementById('input-title').value, content = document.getElementById('input-content').innerHTML, textOnly = document.getElementById('input-content').innerText;
            const tags = ['tag-1', 'tag-2', 'tag-3'].map(id => document.getElementById(id).value.trim().replace('#','')).filter(t => t);
            if (!title.trim() && !textOnly.trim() && !tags.length) return;
            
            const data = { title, content, tags, excerpt: textOnly.slice(0, 100) + (textOnly.length > 100 ? '...' : ''), lastModified: serverTimestamp() };
            try { 
                if (currentId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', currentId), data); 
                else { const dr = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), { ...data, createdAt: serverTimestamp(), authorId: user.uid }); currentId = dr.id; } 
            } catch (e) { console.error("Save Error:", e); }
        };
        
        window.manualSaveWithAlert = async () => { await manualSave(); alert("저장되었습니다."); };

        window.deletePost = async (e, id) => { e.stopPropagation(); if (user.isAnonymous || !confirm("글을 삭제할까요?")) return; try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'posts', id)); if (currentId === id) createNewPost(); } catch(e) { alert("삭제 실패"); } };
        window.deleteCurrentPost = async () => { if (currentId) await deletePost({stopPropagation:()=>{}}, currentId); else createNewPost(); };

        function renderTagCloud() {
            const allTags = new Set(); posts.forEach(p => p.tags && p.tags.forEach(t => allTags.add(t)));
            let h = `<span class="tag-badge ${!selectedTag ? 'active' : ''}" onclick="filterByTag(null)">전체</span>`;
            allTags.forEach(tag => { h += `<span class="tag-badge ${selectedTag === tag ? 'active' : ''}" onclick="filterByTag('${tag}')">#${tag}</span>`; });
            document.getElementById('tag-cloud').innerHTML = h;
        }
        
        window.filterByTag = (tag) => { selectedTag = (selectedTag === tag) ? null : tag; renderTagCloud(); renderBlog(); };
        
        function renderBlog() {
            const el = document.getElementById('blog-list');
            const f = selectedTag ? posts.filter(p => p.tags && p.tags.includes(selectedTag)) : posts;
            el.innerHTML = f.length ? f.map(p => {
                if (!p.title && !p.content) return '';
                const tagHtml = p.tags ? p.tags.map(t=>`<span class="card-tag-item">#${t}</span>`).join(' ') : '';
                return `<article class="post-card" onclick="openReader('${p.id}')"><div class="card-meta"><span>${p.date}</span><div class="card-tags">${tagHtml}</div></div><h2 class="card-title">${p.title||'(제목 없음)'}</h2><div class="card-excerpt">${p.excerpt||''}</div></article>`;
            }).join('') : '<p style="text-align:center; color:var(--text-sub); margin-top:50px;">작성된 글이 없습니다.</p>';
        }
        
        function renderEditorList() {
            const el = document.getElementById('editor-list');
            el.innerHTML = posts.map(p => {
                if (!p.title && !p.content && p.id !== currentId) return '';
                return `<li class="list-item ${p.id === currentId ? 'active' : ''}" onclick="loadPostToEditor('${p.id}')"><div style="font-weight:bold; margin-bottom:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${p.title || '(제목 없음)'}</div><div style="font-size:0.8rem; color:#888;">${p.date}</div><button class="item-delete-btn" onclick="deletePost(event, '${p.id}')"><i class="ph ph-trash"></i></button></li>`;
            }).join('');
        }

        window.loadPostToEditor = (id) => {
            const post = posts.find(p => p.id === id); if (!post) return;
            currentId = id; const titleEl = document.getElementById('input-title'); titleEl.value = post.title || ""; autoResize(titleEl);
            ['tag-1', 'tag-2', 'tag-3'].forEach((tid, i) => document.getElementById(tid).value = post.tags?.[i] ? `#${post.tags[i]}` : "");
            document.getElementById('input-content').innerHTML = post.content || ""; renderEditorList();
            if(window.innerWidth <= 768) toggleSidebar();
        };

        window.openReader = (id) => {
            const p = posts.find(item => item.id === id); document.getElementById('reader-modal').classList.add('open');
            document.getElementById('r-title').textContent = p.title || '(제목 없음)'; document.getElementById('r-date').textContent = p.date;
            document.getElementById('r-tags').textContent = p.tags ? p.tags.map(t => `#${t}`).join(' ') : "";
            document.getElementById('r-content').innerHTML = p.content; document.body.style.overflow = 'hidden'; 
        };
        window.closeReader = () => { document.getElementById('reader-modal').classList.remove('open'); document.body.style.overflow = ''; };
        
        window.toggleTheme = () => {
            const isDark = document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            document.getElementById('theme-icon').className = isDark ? 'ph ph-sun' : 'ph ph-moon';
        };
        
        window.toggleSidebar = () => {
            const sb = document.getElementById('sidebar-panel'), ol = document.getElementById('sidebar-overlay');
            if (window.innerWidth > 768) sb.classList.toggle('collapsed');
            else { const isOpen = sb.classList.toggle('open'); ol.classList.toggle('open'); document.body.style.overflow = isOpen ? 'hidden' : ''; }
        };

        if(localStorage.getItem('theme') === 'dark') { document.body.classList.add('dark-mode'); document.getElementById('theme-icon').className = 'ph ph-sun'; }
    </script>
</body>
</html>
